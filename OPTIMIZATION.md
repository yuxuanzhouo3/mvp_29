# 腾讯云资源优化配置指南

## 已实施的优化

### 1. 数据库连接优化 ✅

**文件**: `lib/prisma.ts`

- **连接池限制**: 从5个连接减少到2个
- **超时时间**: 增加连接和获取超时时间
- **空闲超时**: 5分钟后自动关闭空闲连接
- **连接复用**: 始终缓存 Prisma 客户端实例

### 2. 云托管容器优化 ✅

**文件**: `cloudbaserc.json`

- **CPU**: 0.5 → 0.25 (减少50%)
- **内存**: 1GB → 0.5GB (减少50%)
- **最大实例数**: 50 → 10
- **空闲超时**: 300秒 → 60秒 (更快释放)
- **扩缩容阈值**: 60% → 70% (减少不必要的扩容)

### 3. API 限流保护 ✅

**文件**: `lib/rate-limit.ts`

- **通用 API**: 每分钟100次
- **Rooms API**: 每分钟30次（更严格的限制）
- **Poll 频率限制**: 最小间隔1秒

### 4. Docker 优化 ✅

**文件**: `Dockerfile`

- **内存限制**: 设置 Node.js 最大堆内存为384MB
- **禁用遥测**: 减少不必要的网络请求
- **大小优化**: `--optimize-for-size` 标志

### 5. 缓存层 ✅

**文件**: `lib/cache.ts`

- **全局缓存**: 30秒TTL
- **房间数据缓存**: 5秒TTL
- **设置缓存**: 60秒TTL

## 预期效果

根据以上优化，预计资源消耗将减少：

- **MySQL CCU**: 减少 40-60%
- **云托管 CPU**: 减少 50-70%
- **云托管内存**: 减少 50-70%
- **API 调用次数**: 减少 30-50%

## 部署步骤

1. **提交代码更改**
   ```bash
   git add .
   git commit -m "优化腾讯云资源消耗"
   git push
   ```

2. **重新部署到腾讯云**
   ```bash
   cloudbase framework deploy
   ```

3. **监控资源使用**
   - 在腾讯云控制台查看资源使用情况
   - 观察 24-48 小时内的消耗趋势

## 进一步优化建议

### 1. 数据库层面

- **考虑使用云开发文档数据库**: 如果不需要复杂的关系查询，可以考虑从 MySQL 迁移到 CloudBase 的文档数据库，成本更低
- **数据归档**: 定期清理或归档旧数据
- **索引优化**: 确保常用查询都有适当的索引

### 2. API 层面

- **批量操作**: 合并多个 API 请求为批量操作
- **WebSocket**: 对于实时功能，考虑使用 WebSocket 替代轮询
- **CDN 缓存**: 为静态资源配置更长的缓存时间

### 3. 架构层面

- **静态化**: 使用 Next.js 的 ISR (增量静态再生) 减少服务器端渲染
- **边缘计算**: 将一些简单逻辑放到 CDN 边缘执行
- **函数计算**: 对于低频 API，可以考虑使用云函数替代托管容器

### 4. 监控和告警

建议设置以下监控：
- 数据库连接数告警（超过5个连接时告警）
- API 错误率告警（超过5%时告警）
- 资源消耗告警（超过预算的80%时告警）

## 紧急情况处理

如果资源消耗仍然过高：

1. **立即降低实例规格**: 在 cloudbaserc.json 中进一步降低 cpu 和 mem
2. **临时关闭非核心功能**: 如 rooms 功能的自动清理
3. **启用数据库读写分离**: 将读操作分散到只读实例
4. **联系腾讯云客服**: 申请临时增加资源配额或调整计费方式

## 联系方式

如有问题，可以：
- 查看腾讯云 CloudBase 官方文档
- 在腾讯云控制台提交工单
- 参考 Next.js 和 Prisma 官方最佳实践
