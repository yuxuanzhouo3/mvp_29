# 腾讯云资源优化配置指南

## 已实施的优化

### 1. 数据库连接优化 ✅

**文件**: `lib/prisma.ts`

- **连接池限制**: 从5个连接减少到2个
- **超时时间**: 增加连接和获取超时时间
- **空闲超时**: 5分钟后自动关闭空闲连接
- **连接复用**: 始终缓存 Prisma 客户端实例

### 2. 云托管容器优化 ✅

**文件**: `cloudbaserc.json`

- **CPU**: 0.5 → 0.25 (减少50%)
- **内存**: 1GB → 0.5GB (减少50%)
- **最大实例数**: 50 → 10
- **空闲超时**: 300秒 → 60秒 (更快释放)
- **扩缩容阈值**: 60% → 70% (减少不必要的扩容)

### 3. API 限流保护 ✅

**文件**: `lib/rate-limit.ts`

- **通用 API**: 每分钟100次
- **Rooms API**: 每分钟30次（更严格的限制）
- **Poll 频率限制**: 最小间隔1秒

### 4. Docker 优化 ✅

**文件**: `Dockerfile`

- **内存限制**: 设置 Node.js 最大堆内存为384MB
- **禁用遥测**: 减少不必要的网络请求
- **大小优化**: `--optimize-for-size` 标志

### 5. 缓存层 ✅

**文件**: `lib/cache.ts`

- **全局缓存**: 30秒TTL
- **房间数据缓存**: 5秒TTL
- **设置缓存**: 60秒TTL

### 6. TRTC 语音时长优化 ✅（关键修复）

**问题**: TRTC 语音时长消耗549分钟，远超实际使用

**根因**: 页面关闭时未断开 TRTC 连接，导致会话持续计费

**文件**: `components/voice-chat-interface.tsx`

- **页面关闭清理**: `beforeunload`/`pagehide` 事件同步断开 TRTC
- **后台自动断开**: 页面隐藏30秒后自动断开连接
- **组件卸载清理**: 组件卸载时强制清理 TRTC 实例
- **最大通话限制**: 30分钟自动断开，防止无限时长

**修复详情**:
```typescript
// 1. 页面关闭时同步清理（关键修复）
const handleBeforeUnload = () => {
  sendLeave()
  const trtc = trtcRef.current
  if (trtc) {
    trtc.stopLocalAudio()
    trtc.exitRoom()
    trtc.destroy()
    trtcRef.current = null
  }
}

// 2. 后台自动断开（防止资源浪费）
if (document.hidden) {
  hiddenTimer = setTimeout(() => {
    // 30秒后断开
    trtc.exitRoom()
  }, 30000)
}

// 3. 组件卸载清理
useEffect(() => {
  return () => {
    // 组件卸载时清理 TRTC
    trtc.stopLocalAudio()
    trtc.exitRoom()
    trtc.destroy()
  }
}, [])

// 4. 最大通话时长限制
setTimeout(() => {
  cleanupTrtc() // 30分钟后自动断开
}, 30 * 60 * 1000)
```

### 7. TRTC 后台管理开关 ✅（成本控制）

**功能**: 管理员可以在后台开启/关闭 TRTC 语音通话模式

**文件**: 
- `app/admin/(dashboard)/trtc-toggle.tsx` - 开关组件
- `app/admin/(dashboard)/page.tsx` - 集成到后台首页
- `app/admin/actions/index.ts` - 后端接口
- `app/api/settings/trtc/route.ts` - API 接口
- `components/voice-chat-interface.tsx` - 前端读取设置

**功能特点**:
- **后台控制**: 管理员一键开启/关闭 TRTC 模式
- **即时生效**: 设置保存后立即影响所有用户
- **优雅降级**: 关闭 TRTC 后自动使用标准语音识别（ASR）方案
- **用户提示**: 前端界面显示当前模式状态
- **成本对比**: 
  - TRTC 模式：语音通话 + 实时转录（成本较高）
  - ASR 模式：仅语音识别（成本较低，约为 TRTC 的 1/5）

**使用方法**:
1. 登录后台管理页面
2. 在首页找到 "TRTC 语音通话模式" 开关
3. 关闭后所有新通话将使用标准 ASR 方案
4. 开启后恢复 TRTC 实时通话模式

## 预期效果

根据以上优化，预计资源消耗将减少：

- **MySQL CCU**: 减少 40-60%
- **云托管 CPU**: 减少 50-70%
- **云托管内存**: 减少 50-70%
- **API 调用次数**: 减少 30-50%
- **TRTC 语音时长**: 减少 80-90%（修复连接泄漏 + 可关闭 TRTC）

## 部署步骤

1. **提交代码更改**
   ```bash
   git add .
   git commit -m "优化腾讯云资源消耗，修复TRTC连接泄漏，添加TRTC管理开关"
   git push
   ```

2. **重新部署到腾讯云**
   ```bash
   cloudbase framework deploy
   ```

3. **监控资源使用**
   - 在腾讯云控制台查看资源使用情况
   - 重点观察 TRTC 语音时长消耗
   - 观察 24-48 小时内的消耗趋势

## TRTC 特定监控建议

1. **通话时长告警**: 设置单日通话时长超过60分钟时告警
2. **异常连接检测**: 监控单用户通话时长，超过30分钟视为异常
3. **成本预算**: 设置 TRTC 月度预算告警（如超过50元）
4. **后台开关**: 成本过高时可临时关闭 TRTC 模式

## 进一步优化建议

### 1. 数据库层面

- **考虑使用云开发文档数据库**: 如果不需要复杂的关系查询，可以考虑从 MySQL 迁移到 CloudBase 的文档数据库，成本更低
- **数据归档**: 定期清理或归档旧数据
- **索引优化**: 确保常用查询都有适当的索引

### 2. API 层面

- **批量操作**: 合并多个 API 请求为批量操作
- **WebSocket**: 对于实时功能，考虑使用 WebSocket 替代轮询
- **CDN 缓存**: 为静态资源配置更长的缓存时间

### 3. 架构层面

- **静态化**: 使用 Next.js 的 ISR (增量静态再生) 减少服务器端渲染
- **边缘计算**: 将一些简单逻辑放到 CDN 边缘执行
- **函数计算**: 对于低频 API，可以考虑使用云函数替代托管容器

### 4. 监控和告警

建议设置以下监控：
- 数据库连接数告警（超过5个连接时告警）
- API 错误率告警（超过5%时告警）
- 资源消耗告警（超过预算的80%时告警）
- **TRTC 通话时长告警（单日超过60分钟时告警）**

## 紧急情况处理

如果资源消耗仍然过高：

1. **立即降低实例规格**: 在 cloudbaserc.json 中进一步降低 cpu 和 mem
2. **临时关闭非核心功能**: 如 rooms 功能的自动清理
3. **启用数据库读写分离**: 将读操作分散到只读实例
4. **联系腾讯云客服**: 申请临时增加资源配额或调整计费方式
5. **TRTC 紧急处理**: 
   - 在后台关闭 TRTC 模式（即时生效）
   - 在腾讯云控制台手动踢出异常会话

## 联系方式

如有问题，可以：
- 查看腾讯云 CloudBase 官方文档
- 在腾讯云控制台提交工单
- 参考 Next.js 和 Prisma 官方最佳实践
